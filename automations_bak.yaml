#Should add HA Alarm Panel later
###

#################################################################
## Security System
##################################
- id: sound_alarm_from_notification
  alias: "Sound alarm from notification"
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: SOUND_ALARM
  action:
    - service: homeassistant.turn_on
      entity_id: script.sonos_alarm
    - service: light.turn_on
      data:
        entity_id: group.all_lights

- id: alarm_off_from_notification
  alias: "Turn alarm off from notification"
  trigger:
    platform: event
    event_type: ios.notification_action_fired
    event_data:
      actionName: SILENCE_ALARM
  action:
    - service: media_player.turn_off

## Sensor trip
#################################
- id: sensors_changed_when_nobody_home
  alias: "Sensors tripped when nobody is home"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.cottage_update
      state: 'on'
    - condition: state
      entity_id: input_boolean.cottage_guest_mode
      state: 'off'
    - condition: state
      entity_id: input_select.cottage_status
      state: 'Away'
      for: '00:05:00'
  trigger:
    - platform: state
      entity_id:
        - group.smoke_sensors
        - group.motion_sensors
        - group.door_sensors
      from: 'off'
      to: 'on'
  action:
    # Wait 3 min for wifi to grab if GPS and/or BT failed
    - delay: '00:05:00'
    - condition: state
      entity_id: group.family
      state: 'not_home'
    - service: light.turn_on
      data:
        entity_id: group.all_lights
    - service: notify.mobile_app_lars_iphone
      data_template:
        title: "LARM!"
        message: "The {{ trigger.to_state.name }} was changed to {{ trigger.to_state.state }} while no one is home - {{ as_timestamp(now()) | timestamp_custom('%Y-%m-%d %H:%M:%S', True) }}"
        data:
          push:
            badge: 666
            category: "alarm"
    - service: homeassistant.turn_on
      entity_id: script.sonos_alarm

- id: door_open
  alias: "Door open if night or away"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: group.door_sensors
      state: 'on'
  trigger:
    - platform: state
      entity_id: input_select.cottage_status
      to: 'Night'
    - platform: state
      entity_id: input_select.cottage_status
      to: 'Away'
  action:
    - service: notify.mobile_app_lars_iphone
      data_template:
        title: "Dörr öppen!"
        message: "{{ trigger.to_state.name }} är öppen!"
        data:
          push:
            badge: 100
            category: "notis"

- id: storage_cold
  alias: "Kallt i förråd"
  initial_state: 'on'
  trigger:
    - platform: numeric_state
      entity_id: sensor.smoke_sensor_storage_temperature
      below: 10
  action:
    - service: notify.mobile_app_lars_iphone
      data:
        title: "Larm"
        message: "Det är under 10°C i förrådet!"
        data:
          push:
            badge: 500
            category: "notis"


## Presence
################

#### Arm cottage - all away
########################
- id: arm_cottage
  alias: "Arm the house"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.cottage_update
      state: 'on'
    - condition: state
      entity_id: input_boolean.cottage_guest_mode
      state: 'off'
    - condition: or
      conditions:
        - condition: state
          entity_id: input_select.cottage_status
          state: 'Home'
          for: '00:10:00'
        - condition: state
          entity_id: input_select.cottage_status
          state: 'Standby'
          for: '00:10:00'
  trigger:
   - platform: state
     entity_id: group.family
     to: 'not_home'
     for: '00:05:00'
  action:
     service: homeassistant.turn_on
     entity_id: script.cottage_away

# #### Disarm
- id: disarm_cottage_from_away
  alias: "Disarm house from Away"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.cottage_update
      state: 'on'
    - condition: state
      entity_id: input_select.cottage_status
      state: 'Away'
  trigger:
   - platform: state
     entity_id:
       - person.lars
       - person.emelie
       - group.family
     to: 'home'
   - platform: state
     entity_id: input_boolean.cottage_guest_mode
     to: 'on'
  action:
     service: homeassistant.turn_on
     entity_id: script.cottage_standby

# #### Disarm from night mode
- id: disarm_cottage_from_night
  alias: "Disarm house from Night"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.cottage_update
      state: 'on'
    - condition: state
      entity_id: input_select.cottage_status
      state: 'Night'
  trigger:
   - platform: state
     entity_id:
       - person.lars
       - person.emelie
       - group.family
     to: 'home'
   - platform: state
     entity_id: input_boolean.cottage_guest_mode
     to: 'on'
  action:
     service: homeassistant.turn_on
     entity_id: script.cottage_standby

# ## Home-mode
# #################################
- id: cottage_home
  alias: "House home mode"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: time
          after: '07:30:00'
          before: '22:30:00'
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: state
          entity_id: input_select.cottage_status
          state: 'Standby'
          for: '00:20:00'
        - condition: or
          conditions:
            - condition: state
              entity_id: group.family
              state: 'home'
            - condition: state
              entity_id: input_boolean.cottage_guest_mode
              state: 'on'
  trigger:
    - platform: time_pattern
      minutes: '/10'
  action:
    - service: homeassistant.turn_on
      entity_id: script.cottage_home


## Standby morning mode
#################################

- id: cottage_standby_morning
  alias: "House morning Standby"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_boolean.cottage_guest_mode
              state: 'on'
            - condition: state
              entity_id: group.family
              state: 'home'
  trigger:
    - platform: time
      at: '05:00:00'
  action:
    - service: homeassistant.turn_on
      entity_id: script.cottage_standby

##Standby in the evening
###################
- id: cottage_standby_at_evening
  alias: "House evening Standby"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_boolean.cottage_guest_mode
              state: 'on'
            - condition: state
              entity_id: group.family
              state: 'home'
  trigger:
    - platform: time
      at: '23:00:00'
  action:
    - service: homeassistant.turn_on
      entity_id: script.cottage_standby

## Night mode
#################################
- id: cottage_to_night
  alias: "House Night mode"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: time
          after: '00:15:00'
          before: '05:00:00'
        - condition: state
          entity_id: input_select.cottage_status
          state: 'Standby'
          for: '00:50:00'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_boolean.cottage_guest_mode
              state: 'on'
            - condition: state
              entity_id: group.family
              state: 'home'
  trigger:
    - platform: time_pattern
      minutes: '/10'
  action:
    - service: homeassistant.turn_on
      entity_id: script.cottage_night

#IKEA Modes
#white:
#245, 250, 246
#---
#everyday:
#241, 224, 181
#---
#nightmode:
#239, 210, 117
#color_temp: 454
#---

## Lights
################################
- id: turn_off_lights_when_away
  alias: "Lights off when Away"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.cottage_status
      state: 'Away'
  trigger:
    - platform: time
      at: '00:16:00'
  action:
    - service: light.turn_off
      entity_id:
        - group.bedroom_lights
        - group.window_lights

### Lights
###############
- id: lights_on_pre_kids_bedtime
  alias: "Lights on pre kids bedtime"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_boolean.cottage_update
      state: 'on'
    - condition: time
      after: '15:00:00'
      before: '19:00:00'
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      value_template: "{{ state.attributes.elevation }}"
      # Can be a positive or negative number, negative 0 to -6 = "standard" dusk
      below: 1.0
  action:
    - service: light.turn_on
      data:
        entity_id: group.all_lights
        brightness: 120
        transition: 180

- id: lights_on_evening
  alias: "Lights on evening"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: time
          after: '19:00:00'
          before: '20:30:00'
  trigger:
    - platform: numeric_state
      entity_id: sun.sun
      value_template: "{{ state.attributes.elevation }}"
      # Can be a positive or negative number, negative 0 to -6 = "standard" dusk
      below: 1.0
  action:
    - service: light.turn_on
      data:
        brightness: 20
        entity_id: group.window_lights

- id: morning_lights_weekday
  alias: "Morning lights weekday"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: state
          entity_id: group.family
          state: 'home'
        - condition: state
          entity_id: light.window_lights_downstairs
          state: 'off'
        - condition: time
          after: '05:30:00'
          before: '09:30:00'
        - condition: state
          entity_id: binary_sensor.workday
          state: 'on'
        - condition: or
          conditions:
            - condition: state
              entity_id: sun.sun
              state: 'below_horizon'
            # - condition: numeric_state
            #   entity_id: sensor.lux_allrum_22
            #   below: 30
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_upstairs
      to: 'on'
  action:
    - service: light.turn_on
      data:
        brightness: 255
        entity_id: group.window_lights

### Light triggers during nightmode
#######################
- id: lights_on_up_night_motion
  alias: "Lights upstairs night motion"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: time
          after: '22:00:00'
        # - condition: numeric_state
        #   entity_id: sensor.lux_allrum_22
        #   below: 30
        - condition: state
          entity_id: light.window_lights_upstairs
          state: 'off'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_upstairs
      to: 'on'
  action:
    - service: light.turn_on
      entity_id: light.window_lights_upstairs
    - delay: '00:04:00'
    - service: light.turn_off
      entity_id: light.window_lights_upstairs

- id: lights_on_down_night_motion
  alias: "Lights downstairs night motion"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: time
          after: '22:00:00'
        # - condition: numeric_state
        #   entity_id: sensor.lux_hall_13
        #   below: 30
        - condition: state
          entity_id: light.window_lights_downstairs
          state: 'off'
  trigger:
    - platform: state
      entity_id: binary_sensor.motion_hallway
      to: 'on'
  action:
    - service: light.turn_on
      entity_id: light.window_lights_downstairs
    - delay: '00:04:00'
    - service: light.turn_off
      entity_id: light.window_lights_downstairs

# - id: lights_off_when_high_lux
#   alias: "Lights off during day"
#   initial_state: 'on'
#   condition:
#     - condition: and
#       conditions:
#         - condition: state
#           entity_id: input_boolean.cottage_update
#           state: 'on'
#   trigger:
#     - platform: numeric_state
#       entity_id: sensor.lux_hall_13
#       above: '30'
#     - platform: numeric_state
#       entity_id: sensor.lux_allrum_22
#       above: '30'
#   action:
#     - service: light.turn_off
#       entity_id: group.all_lights

- id: wake_up_lights_weekday
  alias: "Wake up light weekdays"
  initial_state: 'on'
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: input_boolean.cottage_update
          state: 'on'
        - condition: state
          entity_id: binary_sensor.workday
          state: 'on'
        - condition: state
          entity_id: group.family
          state: 'home'
  trigger:
    - platform: time
      at: '05:50'
  action:
    - service: light.turn_on
      data:
        brightness: 200
        transition: 18000
        entity_id: group.bedroom_lights


##### Remotes ######
- id: 'remote_ingrid_on_off'
  alias: 'Ingrid remote on/off'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: deconz_event
    event_data:
      id: ikea_of_sweden_tradfri_remote_control_fef773e0_1_1
      event: 1002
  action:
    service: light.toggle
    entity_id: group.ingrid_lights

- id: 'remote_ingrid_dim_up'
  alias: 'Ingrid remote Dim Up'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: deconz_event
    event_data:
      id: ikea_of_sweden_tradfri_remote_control_fef773e0_1_1
      event: 2002
  action:
    - service: light.turn_on
      data_template:
        entity_id: group.ingrid_lights
        brightness: >
          {% set bri = state_attr('light.lamp', 'brightness') | int %}
          {{ [bri+30, 249] | min }}

- id: 'remote_ingrid_dim_down'
  alias: 'Ingrid Remote Dim Down'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: deconz_event
    event_data:
      id: ikea_of_sweden_tradfri_remote_control_fef773e0_1_1
      event: 3002
  action:
    - service: light.turn_on
      data_template:
        entity_id: group.ingrid_lights
        brightness: >
          {% set bri = state_attr('light.lamp', 'brightness') | int %}
          {{ [bri-30, 0] | max }}

- id: 'remote_bed_time'
  alias: 'Remote all lights on/off'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: deconz_event
    event_data:
      id: ikea_of_sweden_tradfri_on_off_switch_fed2b62d_1_1
      event: 2002
  action:
    service: light.off
    entity_id: group.window_lights

- id: 'remote_on_master_bedroom'
  alias: 'Remote master bedroom on'
  initial_state: 'on'
  trigger:
    platform: event
    event_type: deconz_event
    event_data:
      id: ikea_of_sweden_tradfri_on_off_switch_fed2b62d_1_1
      event: 1002
  action:
    service: light.toggle
    entity_id: light.master_bedroom_window

#### Car heater
- id: car_heater_start
  alias: "Engine heater activate"
  trigger:
    - platform: template
      value_template: "{{ states.sensor.heater_activationtime.state == states('sensor.time') }}"
  condition:
    - condition: and
      conditions:
        - condition: state
          entity_id: group.family
          state: 'home'
        - condition: or
          conditions:
            - condition: state
              entity_id: input_boolean.workdays_only
              state: 'off'
            - condition: and
              conditions:
                - condition: state
                  entity_id: binary_sensor.workday
                  state: 'on'
                - condition: state
                  entity_id: input_boolean.workdays_only
                  state: 'on'
  # If the above conditions are fulfilled, ie. you are home and it's a workday
  # then activate the heater on your selected time
  action:
    - service: switch.turn_on
      entity_id: switch.ikea_of_sweden_tradfri_control_outlet_fefd82b0_1

- id: car_heater_shut_down
  alias: "Engine heater deactivate"
  trigger:
    - platform: template
      value_template: "{{ states('sensor.time') == (states.input_datetime.heater_departuretime.attributes.timestamp | int | timestamp_custom('%H:%M', False)) }}"
  action:
    - delay:
        minutes: "{{ states('input_number.heater_delay') | int }}"
    - service: switch.turn_off
      entity_id: switch.ikea_of_sweden_tradfri_control_outlet_fefd82b0_1

#################################################################
#Test area
#### ------ Fixa senare...
#Typ platta med Floor Plan inkl. kalender m t.ex. Fotboll Ingrid osv. osv.
#Sedan TTS med dessa vid entré på morgonen eller liknanade
#
#Fixa så att en typ boolean m en "Alarm panel" kan avgöra om huset är avlarmet eller inte
#
#### To trigger script when Bosch connected dishwasher is done
- id: ifttt_automation
  alias: "IFTTT automation"
  trigger:
    - platform: event
      event_type: ifttt_webhook_received
      event_data:
        action: call_service
  action:
    - service_template: '{{ trigger.event.data.service }}'
      data_template:
        entity_id: '{{ trigger.event.data.entity_id }}'

# Start circulationg the hot water earlier on weekends
- id: extra_vvc_weekend
  alias: "VVC on weekend earlier"
  condition:
    - condition: state
      entity_id: binary_sensor.workday
      state: 'off'
    - condition: state
      entity_id: group.family
      state: 'home'
  trigger:
    - platform: time
      at: '07:00:00'
  action:
    - service: homeassistant.turn_on
      entity_id: switch.vvc

#### Monnitor the price of electricity
#### getting billed by the hourly price
- id: high_electric_price
  alias: "Högt elpris"
  condition:
    - condition: time
      after: '08:00:00'
      before: '21:00:00'
  trigger:
    - platform: numeric_state
      entity_id: sensor.nibe_31372_10069
      above: 80
  action:
    - service: notify.mobile_app_lars_iphone
      data:
        title: "Elpris!"
        message: "Spot-pris över 80 öre!"
        data:
          push:
            category: "notis"
    - service: script.sonos_say
      data_template:
        sonos_entity: media_player.kok_vardagsrum
        volume: 0.45
        delay: '00:00:15'
        message: 'Hej, tänk på att det just nu är högt elpris. Det ligger just nu på {{ states.sensor.nibe_31372_10069.state }} öre per kWh!'

- id: low_electric_price
  alias: "Lågt elpris"
  condition:
    - condition: time
      after: '08:00:00'
      before: '21:00:00'
  trigger:
    - platform: numeric_state
      entity_id: sensor.nibe_31372_10069
      below: 20
  action:
    - service: notify.mobile_app_lars_iphone
      data:
        title: "Elpris!"
        message: "Spot-pris under 20 öre!"
        data:
          push:
            category: "notis"
    - service: script.sonos_say
      data_template:
        sonos_entity: media_player.kok_vardagsrum
        volume: 0.45
        delay: '00:00:15'
        message: 'Hej, just nu är det lågt elpris, {{ states.sensor.nibe_31372_10069.state }} öre per kWh närmaste timen'


### water the christmas tree, sensor was mounted to low, better luck next year
# - id: esp_christmas_tree_water_level_low
#   alias: 'Larm låg vattennivå granen'
#   condition:
#     - condition: time
#       after: '08:00:00'
#       before: '21:00:00'
#     - condition: state
#       entity_id: group.family
#       state: 'home'
#   trigger:
#     - platform: state
#       entity_id: binary_sensor.esp_christmas_tree_water_level_low
#       to: 'off'
#   action:
#     - service: notify.mobile_app_lars_iphone
#       data:
#         title: "Granen!"
#         message: "Vattna granen, det är nästan slut på vatten!"
#         data:
#           push:
#             category: "alarm"
#     - service: script.sonos_say
#       data_template:
#         sonos_entity: media_player.kok_vardagsrum
#         volume: 0.45
#         delay: '00:00:15'
#         message: 'Hej, det är dags att vattna granen. Det börjar ta slut på vatten!'

- id: update_of_hass
  alias: "Notification Update Hass Available"
  condition:
    - condition: time
      after: '08:00:00'
      before: '20:00:00'
  trigger:
    - platform: state
      entity_id: updater.updater
  action:
    - service: notify.mobile_app_lars_iphone
      data:
        title: "Uppdatering!"
        message: "Ny version av Home Assistant tillgänglig!"
        data:
          push:
            badge: 10
            category: "notis"
    - service: script.sonos_say
      data_template:
        sonos_entity: media_player.kok_vardagsrum
        volume: 0.45
        delay: '00:00:15'
        message: 'Hej, det finns en ny uppdatering av Home Assistant'

#Smoke sensors
#################################################################
- id: fire_alarm
  alias: "Smoke detectors tripped"
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id:
        - group.smoke_sensors
      from: 'off'
      to: 'on'
  action:
    - service: light.turn_on
      data:
        brightness: 255
        color_temp: 454
      entity_id: group.all_lights
    - service: notify.mobile_app_lars_iphone
      data_template:
        title: "BRANDLARM!!"
        message: “En brandvarnare har löst ut!”
        data:
          push:
            badge: 999
            category: "alarm"
    - service: homeassistant.turn_on
      entity_id: script.sonos_fire_alarm
#
# - id: smoke_sensors_auto_on
#   alias: "Auto Smoke Sensors ON"
#   initial_state: 'on'
#   condition:
#     - condition: or
#       conditions:
#         - condition: state
#           entity_id: switch.smokesensor_allrum_18
#           state: 'off'
#         - condition: state
#           entity_id: switch.smokesensor_forrad_126
#           state: 'off'
#         - condition: state
#           entity_id: switch.smokesensor_groventre_124
#           state: 'off'
#         - condition: state
#           entity_id: switch.smokesensor_vardagsrum_133
#           state: 'off'
#   trigger:
#     - platform: time_pattern
#       minutes: '/30'
#   action:
#     - service: homeassistant.turn_on
#       entity_id: group.smoke_units
#
#### neato vaccum robot
- id: cleaning_robot_running
  alias: "Neato running take down sensors"
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: vacuum.stadstina
      to: 'cleaning'
  action:
    - service: input_boolean.turn_on
      entity_id: input_boolean.cottage_guest_mode

- id: cleaning_robot_docked
  alias: "Neato finished"
  initial_state: 'on'
  condition:
    - condition: state
      entity_id: input_select.cottage_status
      state: 'Away'
  trigger:
    - platform: state
      entity_id: vacuum.stadstina
      to: 'docked'
  action:
    - service: input_boolean.turn_off
      entity_id: input_boolean.cottage_guest_mode


##### Sonos Beam set to night mode
## From https://github.com/arsaboo/homeassistant-config/
- id: sonos_enable_speech_enhance_and_night_sound
  alias: "Sonos Enable speech enhance and night sound"
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: media_player.allrum
      from: 'off'
      to: 'on'
  condition:
    - condition: time
      after: '20:30:00'
      before: '01:00:00'
  action:
    - service: sonos.set_option
      data:
        entity_id: media_player.sallskapsrum
        night_sound: True
    - service: sonos.set_option
      data:
        entity_id: media_player.sallskapsrum
        speech_enhance: True

- id: sonos_disable_speech_enhance_and_night_sound
  alias: "Sonos Disable speech enhance and night sound"
  initial_state: 'on'
  trigger:
    - platform: state
      entity_id: media_player.allrum
      to: 'off'
  condition:
    - condition: time
      after: '20:30:00'
      before: '07:00:00'
  action:
    - service: sonos.set_option
      data:
        entity_id: media_player.sallskapsrum
        night_sound: False
    - service: sonos.set_option
      data:
        entity_id: media_player.sallskapsrum
        speech_enhance: False
