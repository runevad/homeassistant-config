##############
### Sensors
##############

  - platform: time_date
    display_options:
      - 'time'

  - platform: template
    sensors:
      cottage_status:
        friendly_name: "Cottage status"
        value_template: >-
          {{ states("input_select.cottage_status") }}

      energy_month:
        friendly_name: Elförbrukning månad
        unit_of_measurement: "kWh"
        value_template: >-
          {{ float(states.sensor.energy_tot_128.attributes.current_energy_kwh) | round(1) }}

      energy_car_heater:
        friendly_name: Elförbrukning motorvärmare
        unit_of_measurement: "kWh"
        value_template: >-
          {{ float(states.switch.car_heater_149.attributes.current_energy_kwh) | round(1) }}


#NAS
  - platform: synologydsm
    host: 192.168.1.4
    port: 5000
    username: !secret synology_user
    password: !secret synology_pass
    ssl: false
    monitored_conditions:
      - cpu_total_load
      - memory_real_usage
      - volume_percentage_used
      - disk_status
      - volume_status
      - disk_temp

  - platform: template
    sensors:
      heater_departuretime:
        friendly_name: 'Departure time'
        value_template: '{% if states.input_number.heater_hour.state|round(0)|string|length == 1 %}0{% endif %}{{ states.input_number.heater_hour.state|round(0)|string }}:{% if states.input_number.heater_minute.state|round(0)|string|length == 1 %}0{% endif %}{{ states.input_number.heater_minute.state|round(0)|string }}'

      heater_activationtime:
        friendly_name: 'Calculated activation time'
        value_template: >-
          {% set atime = (states.sensor.heater_temptime.state|round(0) * 60) %}
          {% if states.input_number.heater_hour.state|round(0)|string|length == 1 %} {% set time = 0 %} {% endif %}
          {% set time = time|string + states.input_number.heater_hour.state|round(0)|string + ':' %}
          {% if states.input_number.heater_minute.state|round(0)|string|length == 1 %} {% set time = time|string + '0' %} {% endif %}
          {% set time = time|string + states.input_number.heater_minute.state|round(0)|string %}
          {{ (as_timestamp(now().strftime("%Y-%m-%d") + ' ' + time) - atime) | timestamp_custom("%H:%M")|string }}

      heater_temptime:
        friendly_name: 'Temperature adjusted time'
        value_template: >-
          {% set temp = states.sensor.heater_forecast.state|int %}
          {% if temp <= -15 %} {% set t = 1 %}
          {% elif temp > 5 %} {% set t = 20 %}
          {% else %} {% set t = (15 + temp) %} {% endif %}
          {{ (states.input_number.heater_maxmin.state|round(0)/(t**0.3))|int }}

      heater_forecast:
        friendly_name: 'Temperature forecast'
        value_template: >-
          {% if states.sensor.time.state < states.sensor.heater_departuretime.state and states.sensor.time.state > '00:00' %}
          {% set forecast = states.weather.smhi_home.attributes.forecast[0].templow %}
          {% else %}
          {% set forecast = states.weather.smhi_home.attributes.temperature %}
          {% endif %}
          {{ forecast }}

#### MQTT stuff
#### Weather station
  - platform: mqtt
    name: Outdoor temperature
    state_topic: wemos_weather_station/sensor/outdoor_temperature/state
    unit_of_measurement: '°C'
    icon: mdi:thermometer

  - platform: mqtt
    name: Outdoor pressure
    state_topic: wemos_weather_station/sensor/outdoor_pressure/state
    unit_of_measurement: 'hPa'
    icon: mdi:gauge

  - platform: mqtt
    name: Outdoor humidity
    state_topic: wemos_weather_station/sensor/outdoor_humidity/state
    unit_of_measurement: '%'
    icon: mdi:water-percent

  - platform: mqtt
    name: Weather station signal strength
    state_topic: wemos_weather_station/sensor/weather_station_signal_strength/state
    unit_of_measurement: 'dB'
    icon: mdi:wifi

  - platform: mqtt
    name: Weather station battery level
    state_topic: wemos_weather_station/sensor/weather_station_battery_level/state
    unit_of_measurement: '%'
    icon: mdi:battery

  - platform: mqtt
    name: Weather station run time
    state_topic: wemos_weather_station/sensor/weather_station_run_time/state
    unit_of_measurement: 'ms'
    icon: mdi:timer
